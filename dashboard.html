<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Amarante&family=Noto+Sans+KR&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Noto Sans KR', sans-serif; background:#f5f5f5; color:#222; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
main.container { max-width:600px; width:100%; padding:2rem; display:flex; flex-direction:column; align-items:center; }
h1 { font-family:'Amarante', cursive; text-align:center; margin-bottom:1rem; }
#avatar { width:120px; height:120px; border-radius:50%; object-fit:cover; border:2px solid #222; margin-bottom:1rem; cursor:pointer; transition:transform 0.2s; }
#avatar:hover { transform:scale(1.05); }
input[type="text"], input[type="file"] { width:100%; padding:0.5rem; margin:0.5rem 0; font-size:1rem; }
#saveHubBtn { padding:0.6rem 1.5rem; font-size:1rem; cursor:pointer; margin-top:1rem; background:#222; color:#fff; border:none; border-radius:5px; transition:background 0.2s; }
#saveHubBtn:hover { background:#555; }
#profileError { color:red; margin-top:0.5rem; }
</style>
</head>
<body>
<main class="container">
  <h1>Profile Hub</h1>
  <img id="avatar" src="default-avatar.png" alt="Avatar">
  <input type="text" id="usernameInput" placeholder="Enter your username">
  <input type="file" id="avatarInput" accept="image/*">
  <button id="saveHubBtn">Save & Go to Hub</button>
  <p id="profileError"></p>
</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// âœ… Using pre-registered Supabase credentials
const supabaseUrl = SUPABASE_URL;
const supabaseKey = SUPABASE_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

const avatarImg = document.getElementById('avatar');
const usernameInput = document.getElementById('usernameInput');
const avatarInput = document.getElementById('avatarInput');
const saveBtn = document.getElementById('saveHubBtn');
const profileError = document.getElementById('profileError');

// Load profile for current user
async function loadProfile() {
  const { data: { session } } = await supabase.auth.getSession();
  if(!session || !session.user){ window.location.href = 'login.html'; return; }
  const user = session.user;

  const { data: profile } = await supabase.from('profiles').select('*').eq('user_id', user.id).single();
  if(profile){
    usernameInput.value = profile.username;
    if(profile.avatar_url){ avatarImg.src = profile.avatar_url; }
  } else {
    // Auto-create default profile
    const defaultUsername = 'New User';
    await supabase.from('profiles').insert({ user_id: user.id, username: defaultUsername });
    usernameInput.value = defaultUsername;
  }
}

avatarImg.addEventListener('click', ()=>avatarInput.click());

// Save profile & redirect
saveBtn.addEventListener('click', async () => {
  profileError.textContent = '';
  const username = usernameInput.value.trim();
  if(!username){ profileError.textContent = 'Username cannot be empty.'; return; }

  const { data: { session } } = await supabase.auth.getSession();
  const user = session.user;

  let avatar_url = null;
  if(avatarInput.files[0]){
    const { data, error } = await supabase.storage.from('avatars').upload(`${user.id}.png`, avatarInput.files[0], { upsert:true });
    if(error){ profileError.textContent = 'Avatar upload failed: ' + error.message; return; }
    const { publicUrl } = supabase.storage.from('avatars').getPublicUrl(`${user.id}.png`);
    avatar_url = publicUrl;
  }

  const { error } = await supabase.from('profiles').upsert([{ user_id: user.id, username, avatar_url }], { onConflict: 'user_id' });
  if(error){ profileError.textContent = error.message; return; }

  // Redirect to main hub section
  window.location.href = 'hub.html';
});

// Initialize
loadProfile();
</script>
</body>
</html>
